fn malloc(i64 size) shellcode i64 { 0x55 0x48 0x89 0xE5 0x48 0x89 0xFE 0xB8 0x0C 0x00 0x00 0x00 0x48 0x31 0xFF 0x0F 0x05 0x48 0x89 0xC7 0x48 0x01 0xF7 0xB8 0x0C 0x00 0x00 0x00 0x0F 0x05 0x48 0x89 0xEC 0x5D 0xC3 }

// Helper for write syscall
fn syscall_write(i64 fd, i64 buf, i64 count) shellcode i64 {
    0x55                    // push rbp
    0x48 0x89 0xE5          // mov rbp, rsp
    0xB8 0x01 0x00 0x00 0x00 // mov eax, 1 (sys_write)
    0x0F 0x05               // syscall
    0x48 0x89 0xEC          // mov rsp, rbp
    0x5D                    // pop rbp
    0xC3                    // ret
}

// print_string - prints a null-terminated string
fn print_string(i64 str) {
    i64 len = 0;
    i64 temp = str;
    loop {
        i64 char_val = $temp;
        if char_val == 0 {
            break;
        }
        len = len + 1;
        temp = temp + 1;
    }
    syscall_write(1, str, len);
}

// Helper to allocate a single character  
fn alloc_char(i64 c) i64 {
    i64 mem = alloc(1);
    $mem = c;
    return mem;
}

// print_integer - prints a signed 64-bit integer
fn print_integer(i64 num) {
    if num < 0 {
        syscall_write(1, alloc_char(45), 1);
        num = 0 - num;
    }
    
    if num == 0 {
        syscall_write(1, alloc_char(48), 1);
        return 0;
    }
    
    array[20] i64 digits;
    i64 digit_count = 0;
    
    loop {
        if num == 0 {
            break;
        }
        i64 digit = num % 10;
        digits[digit_count] = digit + 48;
        digit_count = digit_count + 1;
        num = num / 10;
    }
    
    loop {
        if digit_count == 0 {
            break;
        }
        digit_count = digit_count - 1;
        i64 char_val = digits[digit_count];
        syscall_write(1, alloc_char(char_val), 1);
    }
    
    return 0;
}

fn main() {
    print_string("=== Comprehensive Language Feature Test ===\n\n");
    
    // Test 1: Basic variables
    print_string("Test 1: Basic Variables\n");
    i64 a = 10;
    i64 b = 20;
    i64 sum = a + b;
    print_string("  10 + 20 = ");
    print_integer(sum);
    print_string("\n");
    
    // Test 2: Arithmetic operations
    print_string("\nTest 2: Arithmetic Operations\n");
    i64 x = 100;
    i64 y = 25;
    print_string("  100 - 25 = ");
    print_integer(x - y);
    print_string("\n");
    print_string("  100 * 2 = ");
    print_integer(x * 2);
    print_string("\n");
    print_string("  100 / 25 = ");
    print_integer(x / y);
    print_string("\n");
    
    // Test 3: Simple loop
    print_string("\nTest 3: Simple Loop\n");
    i64 counter = 0;
    i64 loop_sum = 0;
    loop {
        if counter >= 5 {
            break;
        }
        loop_sum = loop_sum + counter;
        counter = counter + 1;
    }
    print_string("  Sum of 0-4: ");
    print_integer(loop_sum);
    print_string("\n");
    
    // Test 4: Array declaration and initialization
    print_string("\nTest 4: Array Declaration\n");
    array[5] i64 arr;
    arr[0] = 100;
    arr[1] = 200;
    arr[2] = 300;
    arr[3] = 400;
    arr[4] = 500;
    print_string("  arr[0] = ");
    print_integer(arr[0]);
    print_string("\n");
    print_string("  arr[4] = ");
    print_integer(arr[4]);
    print_string("\n");
    
    // Test 5: Array with dynamic indexing
    print_string("\nTest 5: Dynamic Array Access\n");
    i64 arr_sum = 0;
    i64 idx = 0;
    loop {
        if idx >= 5 {
            break;
        }
        arr_sum = arr_sum + arr[idx];
        idx = idx + 1;
    }
    print_string("  Sum of array: ");
    print_integer(arr_sum);
    print_string("\n");
    
    // Test 6: Simple memory allocation
    print_string("\nTest 6: Memory Allocation\n");
    i64 mem1 = alloc(8);
    $mem1 = 42;
    print_string("  Value at allocated memory: ");
    print_integer($mem1);
    print_string("\n");
    
    // Test 7: Multiple allocations
    print_string("\nTest 7: Multiple Allocations\n");
    i64 mem2 = alloc(8);
    i64 mem3 = alloc(8);
    $mem2 = 100;
    $mem3 = 200;
    print_string("  mem2: ");
    print_integer($mem2);
    print_string(", mem3: ");
    print_integer($mem3);
    print_string("\n");
    
    // Test 8: Pointer arithmetic
    print_string("\nTest 8: Pointer Arithmetic\n");
    i64 base = alloc(24);
    $base = 10;
    $(base + 8) = 20;
    $(base + 16) = 30;
    print_string("  base[0]: ");
    print_integer($base);
    print_string(", base[1]: ");
    print_integer($(base + 8));
    print_string(", base[2]: ");
    print_integer($(base + 16));
    print_string("\n");
    
    // Test 9: Array storing pointers
    print_string("\nTest 9: Array of Pointers\n");
    array[3] i64 mem_arr;
    mem_arr[0] = alloc(8);
    mem_arr[1] = alloc(8);
    mem_arr[2] = alloc(8);
    $(mem_arr[0]) = 111;
    $(mem_arr[1]) = 222;
    $(mem_arr[2]) = 333;
    print_string("  mem_arr[0]: ");
    print_integer($(mem_arr[0]));
    print_string(", mem_arr[1]: ");
    print_integer($(mem_arr[1]));
    print_string(", mem_arr[2]: ");
    print_integer($(mem_arr[2]));
    print_string("\n");
    
    // Test 10: Loop with array and dereference
    print_string("\nTest 10: Loop with Array Access and Dereference\n");
    i64 i = 0;
    loop {
        if i >= 3 {
            break;
        }
        i64 addr = mem_arr[i];
        i64 val = $addr;
        print_string("  Element ");
        print_integer(i);
        print_string(": ");
        print_integer(val);
        print_string("\n");
        i = i + 1;
    }
    
    // Test 11: Linked structure
    print_string("\nTest 11: Linked Structure\n");
    i64 node1 = alloc(16);
    $node1 = 1000;
    $(node1 + 8) = 0;
    
    i64 node2 = alloc(16);
    $node2 = 2000;
    $(node2 + 8) = 0;
    
    i64 node3 = alloc(16);
    $node3 = 3000;
    $(node3 + 8) = 0;
    
    $(node1 + 8) = node2;
    $(node2 + 8) = node3;
    
    i64 current = node1;
    i64 node_count = 0;
    loop {
        if current == 0 {
            break;
        }
        print_string("  Node ");
        print_integer(node_count);
        print_string(" value: ");
        print_integer($current);
        print_string("\n");
        
        i64 next_mem = current + 8;
        current = $next_mem;
        node_count = node_count + 1;
    }
    
    // Test 12: Array storing linked list nodes
    print_string("\nTest 12: Array of Linked List Nodes\n");
    array[4] i64 nodes;
    
    nodes[0] = alloc(24);
    nodes[1] = alloc(24);
    nodes[2] = alloc(24);
    nodes[3] = alloc(24);
    
    $(nodes[0]) = 100;
    $(nodes[0] + 8) = nodes[1];
    $(nodes[0] + 16) = 1;
    
    $(nodes[1]) = 200;
    $(nodes[1] + 8) = nodes[2];
    $(nodes[1] + 16) = 2;
    
    $(nodes[2]) = 300;
    $(nodes[2] + 8) = nodes[3];
    $(nodes[2] + 16) = 3;
    
    $(nodes[3]) = 400;
    $(nodes[3] + 8) = 0;
    $(nodes[3] + 16) = 4;
    
    print_string("  Forward traversal:\n");
    current = nodes[0];
    loop {
        if current == 0 {
            break;
        }
        print_string("    value=");
        print_integer($current);
        print_string(", id=");
        print_integer($(current + 16));
        print_string("\n");
        
        current = $(current + 8);
    }
    
    // Test 13: Reverse array traversal with stored nodes
    print_string("\nTest 13: Reverse Traversal of Stored Nodes\n");
    i64 rev_i = 3;
    loop {
        i64 node_addr = nodes[rev_i];
        print_string("  nodes[");
        print_integer(rev_i);
        print_string("]: value=");
        print_integer($node_addr);
        print_string(", id=");
        print_integer($(node_addr + 16));
        print_string("\n");
        
        if rev_i == 0 {
            break;
        }
        rev_i = rev_i - 1;
    }
    
    print_string("\n=== All Tests Completed Successfully! ===\n");
    return 0;
}
