include "../lib/stdio.occ"

fn malloc(i64 size) shellcode i64 { 0x55 0x48 0x89 0xE5 0x48 0x89 0xFE 0xB8 0x0C 0x00 0x00 0x00 0x48 0x31 0xFF 0x0F 0x05 0x48 0x89 0xC7 0x48 0x01 0xF7 0xB8 0x0C 0x00 0x00 0x00 0x0F 0x05 0x48 0x89 0xEC 0x5D 0xC3 }

fn main() {
    i64 p = malloc(16);
    $p = 10;
    $(p + 8) = malloc(16);
    $($(p + 8)) = 20;
    $($(p + 8) + 8) = malloc(16);
    $($($(p + 8) + 8)) = 30;
    $($($(p + 8) + 8) + 8) = 0;
    
    print_string("Linked list values:\n");
    
    i64 current = p;
    i64 depth = 0;
    
    loop {
        print_string("Depth ");
        print_integer(depth);
        print_string(": ");
        print_integer($current);
        print_string("\n");
        
        i64 next_addr = current + 8;
        i64 next = $next_addr;
        
        if next == 0 {
            break;
        }
        
        current = next;
        depth = depth + 1;
    }
}
